<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sincerely Yours Media - Deal Memo Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .login-container {
            background: white;
            padding: 60px 40px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
            max-width: 500px;
            margin: 100px auto;
        }
        
        .login-container h1 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .login-container p {
            color: #666;
            margin-bottom: 30px;
        }
        
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: none;
        }
        
        .container.authenticated {
            display: block;
        }
        
        h1 {
            color: #333;
            border-bottom: 3px solid #6B46C1;
            padding-bottom: 10px;
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 20px;
            font-style: italic;
        }
        
        .user-info {
            padding: 10px;
            margin: 20px 0;
            border-radius: 5px;
            background: #d4edda;
            color: #155724;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .form-section {
            margin: 20px 0;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 5px;
            border-left: 4px solid #6B46C1;
        }
        
        .form-section h3 {
            margin-top: 0;
            color: #555;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #666;
            font-size: 13px;
        }
        
        input, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        select {
            cursor: pointer;
        }
        
        button {
            background: #6B46C1;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 20px;
            font-weight: bold;
        }
        
        button:hover {
            background: #5a3ca1;
        }
        
        .google-btn {
            background: #4285f4;
        }
        
        .google-btn:hover {
            background: #357ae8;
        }
        
        .sign-out-btn {
            background: #666;
            padding: 8px 16px;
            font-size: 14px;
            margin: 0;
        }
        
        .sign-out-btn:hover {
            background: #555;
        }
        
        #output {
            margin-top: 30px;
            padding: 25px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 5px;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            line-height: 1.6;
            display: none;
            font-size: 13px;
        }
        
        .copy-btn {
            background: #2196F3;
            margin-left: 10px;
        }
        
        .copy-btn:hover {
            background: #0b7dda;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .info-text {
            color: #888;
            font-size: 12px;
            font-style: italic;
            margin-top: 3px;
        }
        
        .success-message {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 12px;
            border-radius: 4px;
            margin: 15px 0;
            display: none;
        }
        
        .error-message {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 12px;
            border-radius: 4px;
            margin: 15px 0;
            display: none;
        }
        
        .access-denied {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 20px;
            border-radius: 4px;
            margin: 20px 0;
            text-align: center;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-container" id="loginContainer">
        <h1>Sincerely Yours Media</h1>
        <p>Deal Memo Generator</p>
        <p style="font-size: 14px; color: #888;">Access restricted to Sincerely Yours team members</p>
        <div id="googleSignInDiv" style="display: flex; justify-content: center; margin: 20px 0;">
            <!-- Google Sign In Button will be rendered here -->
            <button id="fallbackSignIn" class="google-btn" style="display: none; margin: 0; padding: 12px 24px;">
                Sign in with Google
            </button>
        </div>
        <div class="error-message" id="loginError" style="margin-top: 20px;"></div>
    </div>

    <!-- Main App (Hidden until authenticated) -->
    <div class="container" id="mainContainer">
        <h1>Sincerely Yours Media - Deal Memo Generator</h1>
        <div class="subtitle">Recording Agreement Deal Memo Template</div>
        
        <div class="user-info" id="userInfo">
            <div>
                <span>ðŸ‘¤ Logged in as: </span>
                <strong id="userEmail"></strong>
            </div>
            <button class="sign-out-btn" id="signOutBtn">Sign Out</button>
        </div>
        
        <div class="success-message" id="successMessage"></div>
        <div class="error-message" id="errorMessage"></div>
        
        <!-- Form sections remain the same as original -->
        <div class="form-section">
            <h3>Basic Information</h3>
            <div class="form-row">
                <div>
                    <label>Artist Name *</label>
                    <input type="text" id="artistName" placeholder="e.g., John Smith" required>
                </div>
                <div>
                    <label>Agreement Date *</label>
                    <input type="date" id="date" required>
                </div>
                <div>
                    <label>Email Address</label>
                    <input type="email" id="email" placeholder="artist@email.com">
                    <div class="info-text">Leave blank for "VIA EMAIL"</div>
                </div>
            </div>
        </div>
        
        <!-- Rest of form sections... (keeping them for brevity) -->
        
        <div class="button-group">
            <button id="generatePdfBtn">Generate Deal Memo PDF</button>
            <button class="copy-btn" id="copyBtn">Generate & Copy Text</button>
            <button class="google-btn" id="createGoogleDocBtn">Create Google Doc</button>
        </div>
        
        <div id="output"></div>
    </div>
    
    <script>
        // Google API Configuration
        const CLIENT_ID = '464744009556-3cuv6q0s1tlvta2ig8rp61g6bkfm7v7k.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyCZcBYSS2Mkh2bRaISVdKLmLtwGD8PjIkQ';
        const DISCOVERY_DOCS = [
            'https://docs.googleapis.com/$discovery/rest?version=v1',
            'https://sheets.googleapis.com/$discovery/rest?version=v4'
        ];
        const SCOPES = 'https://www.googleapis.com/auth/documents https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/spreadsheets';
        
        // IMPORTANT: Replace with your Google Sheet ID
        const ACTIVITY_LOG_SHEET_ID = 'YOUR_GOOGLE_SHEET_ID_HERE'; // <-- YOU NEED TO SET THIS
        
        let tokenClient;
        let accessToken = null;
        let currentUser = null;
        
        // Log activity to Google Sheets
        async function logActivity(email, name, status) {
            if (!accessToken || !ACTIVITY_LOG_SHEET_ID || ACTIVITY_LOG_SHEET_ID === 'YOUR_GOOGLE_SHEET_ID_HERE') {
                console.log('Activity logging not configured');
                return;
            }
            
            try {
                const timestamp = new Date().toLocaleString();
                const app = 'US Deal Memo';
                const ipAddress = await fetch('https://api.ipify.org?format=json')
                    .then(r => r.json())
                    .then(data => data.ip)
                    .catch(() => 'Unknown');
                
                const values = [[timestamp, email, name, app, status, ipAddress]];
                
                const response = await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${ACTIVITY_LOG_SHEET_ID}/values/Sheet1!A:F:append?valueInputOption=RAW`,
                    {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${accessToken}`,
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            values: values
                        })
                    }
                );
                
                if (response.ok) {
                    console.log('Activity logged successfully');
                } else {
                    console.error('Failed to log activity:', await response.text());
                }
            } catch (error) {
                console.error('Error logging activity:', error);
            }
        }
        
        // Initialize Google Sign-In
        function initializeGoogleSignIn() {
            try {
                // Check if Google Identity Services is loaded
                if (typeof google !== 'undefined' && google.accounts) {
                    google.accounts.id.initialize({
                        client_id: CLIENT_ID,
                        callback: handleCredentialResponse,
                        auto_select: false,
                        cancel_on_tap_outside: true,
                    });
                    
                    google.accounts.id.renderButton(
                        document.getElementById("googleSignInDiv"),
                        { 
                            theme: "filled_blue", 
                            size: "large",
                            text: "sign_in_with",
                            shape: "rectangular",
                            width: 300
                        }
                    );
                    
                    // Initialize token client for additional scopes
                    tokenClient = google.accounts.oauth2.initTokenClient({
                        client_id: CLIENT_ID,
                        scope: SCOPES,
                        callback: (response) => {
                            accessToken = response.access_token;
                        },
                    });
                } else {
                    // Show fallback button if Google Sign-In doesn't load
                    console.log('Google Sign-In not loaded, showing fallback button');
                    document.getElementById('fallbackSignIn').style.display = 'block';
                }
            } catch (error) {
                console.error('Error initializing Google Sign-In:', error);
                document.getElementById('fallbackSignIn').style.display = 'block';
            }
        }
        
        // Handle Google Sign-In response
        async function handleCredentialResponse(response) {
            // Decode JWT to get user info
            const responsePayload = decodeJwtResponse(response.credential);
            
            // Check if email domain is @sincerely-yours.xyz
            const email = responsePayload.email;
            const emailDomain = email.split('@')[1];
            
            if (emailDomain !== 'sincerely-yours.xyz') {
                showLoginError(`Access denied. This tool is only available to Sincerely Yours team members. You are signed in as ${email}`);
                // Log denied attempt
                await logActivity(email, responsePayload.name, 'Access Denied');
                return;
            }
            
            // User is authorized
            currentUser = {
                email: email,
                name: responsePayload.name,
                picture: responsePayload.picture
            };
            
            // Request additional permissions for Google Docs and Sheets
            tokenClient.requestAccessToken();
            
            // Log successful login
            await logActivity(email, responsePayload.name, 'Login Success');
            
            // Show the main app
            showMainApp();
        }
        
        // Decode JWT token
        function decodeJwtResponse(token) {
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            
            return JSON.parse(jsonPayload);
        }
        
        // Show main app after successful authentication
        function showMainApp() {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('mainContainer').classList.add('authenticated');
            document.getElementById('userEmail').textContent = currentUser.email;
        }
        
        // Show login error
        function showLoginError(message) {
            const errorDiv = document.getElementById('loginError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 10000);
        }
        
        // Sign out
        async function signOut() {
            // Log sign out
            if (currentUser) {
                await logActivity(currentUser.email, currentUser.name, 'Sign Out');
            }
            
            google.accounts.id.disableAutoSelect();
            currentUser = null;
            accessToken = null;
            document.getElementById('mainContainer').classList.remove('authenticated');
            document.getElementById('loginContainer').style.display = 'block';
            
            // Clear form data
            document.getElementById('artistName').value = '';
            document.getElementById('email').value = '';
            
            // Revoke token if exists
            if (accessToken) {
                google.accounts.oauth2.revoke(accessToken);
            }
        }
        
        // Show success message
        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 5000);
        }
        
        // Show error message
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }
        
        // Set up when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Set today's date
            document.getElementById('date').valueAsDate = new Date();
            
            // Wait for Google Sign-In to load, then initialize
            if (typeof google !== 'undefined') {
                initializeGoogleSignIn();
            } else {
                // Try again after a short delay
                setTimeout(() => {
                    initializeGoogleSignIn();
                }, 1000);
                
                // And show fallback button as backup
                setTimeout(() => {
                    if (!document.querySelector('#googleSignInDiv iframe')) {
                        document.getElementById('fallbackSignIn').style.display = 'block';
                    }
                }, 2000);
            }
            
            // Load Google API
            if (typeof gapi !== 'undefined') {
                gapi.load('client', () => {
                    gapi.client.init({
                        apiKey: API_KEY,
                        discoveryDocs: DISCOVERY_DOCS,
                    });
                });
            }
            
            // Attach button handlers
            document.getElementById('signOutBtn').addEventListener('click', signOut);
            
            // Fallback button handler
            document.getElementById('fallbackSignIn').addEventListener('click', () => {
                // Try to initialize Google Sign-In again
                initializeGoogleSignIn();
                // If still not available, use OAuth2 flow
                if (tokenClient) {
                    tokenClient.requestAccessToken();
                } else {
                    showLoginError('Unable to load Google Sign-In. Please refresh the page and try again.');
                }
            });
        });
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sincerely Yours Media - Deal Memo Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .login-container {
            background: white;
            padding: 60px 40px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
            max-width: 500px;
            margin: 100px auto;
        }
        
        .login-container h1 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .login-container p {
            color: #666;
            margin-bottom: 30px;
        }
        
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: none;
        }
        
        .container.authenticated {
            display: block;
        }
        
        h1 {
            color: #333;
            border-bottom: 3px solid #6B46C1;
            padding-bottom: 10px;
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 20px;
            font-style: italic;
        }
        
        .user-info {
            padding: 10px;
            margin: 20px 0;
            border-radius: 5px;
            background: #d4edda;
            color: #155724;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .form-section {
            margin: 20px 0;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 5px;
            border-left: 4px solid #6B46C1;
        }
        
        .form-section h3 {
            margin-top: 0;
            color: #555;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #666;
            font-size: 13px;
        }
        
        input, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        select {
            cursor: pointer;
        }
        
        button {
            background: #6B46C1;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 20px;
            font-weight: bold;
        }
        
        button:hover {
            background: #5a3ca1;
        }
        
        .google-btn {
            background: #4285f4;
        }
        
        .google-btn:hover {
            background: #357ae8;
        }
        
        .sign-out-btn {
            background: #666;
            padding: 8px 16px;
            font-size: 14px;
            margin: 0;
        }
        
        .sign-out-btn:hover {
            background: #555;
        }
        
        #output {
            margin-top: 30px;
            padding: 25px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 5px;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            line-height: 1.6;
            display: none;
            font-size: 13px;
        }
        
        .copy-btn {
            background: #2196F3;
            margin-left: 10px;
        }
        
        .copy-btn:hover {
            background: #0b7dda;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .info-text {
            color: #888;
            font-size: 12px;
            font-style: italic;
            margin-top: 3px;
        }
        
        .success-message {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 12px;
            border-radius: 4px;
            margin: 15px 0;
            display: none;
        }
        
        .error-message {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 12px;
            border-radius: 4px;
            margin: 15px 0;
            display: none;
        }
        
        .access-denied {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 20px;
            border-radius: 4px;
            margin: 20px 0;
            text-align: center;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-container" id="loginContainer">
        <h1>Sincerely Yours Media</h1>
        <p>Deal Memo Generator</p>
        <p style="font-size: 14px; color: #888;">Access restricted to Sincerely Yours team members</p>
        <div id="googleSignInDiv" style="display: flex; justify-content: center; margin: 20px 0;">
            <!-- Google Sign In Button will be rendered here -->
            <button id="fallbackSignIn" class="google-btn" style="display: none; margin: 0; padding: 12px 24px;">
                Sign in with Google
            </button>
        </div>
        <div class="error-message" id="loginError" style="margin-top: 20px;"></div>
    </div>

    <!-- Main App (Hidden until authenticated) -->
    <div class="container" id="mainContainer">
        <h1>Sincerely Yours Media - Deal Memo Generator</h1>
        <div class="subtitle">Recording Agreement Deal Memo Template</div>
        
        <div class="user-info" id="userInfo">
            <div>
                <span>ðŸ‘¤ Logged in as: </span>
                <strong id="userEmail"></strong>
            </div>
            <button class="sign-out-btn" id="signOutBtn">Sign Out</button>
        </div>
        
        <div class="success-message" id="successMessage"></div>
        <div class="error-message" id="errorMessage"></div>
        
        <div class="form-section">
            <h3>Basic Information</h3>
            <div class="form-row">
                <div>
                    <label>Artist Name *</label>
                    <input type="text" id="artistName" placeholder="e.g., John Smith" required>
                </div>
                <div>
                    <label>Agreement Date *</label>
                    <input type="date" id="date" required>
                </div>
                <div>
                    <label>Email Address</label>
                    <input type="email" id="email" placeholder="artist@email.com">
                    <div class="info-text">Leave blank for "VIA EMAIL"</div>
                </div>
            </div>
        </div>
        
        <div class="form-section">
            <h3>Deal Structure</h3>
            <div class="form-row">
                <div>
                    <label>Deal Type *</label>
                    <select id="dealType">
                        <option value="album">Studio Album</option>
                        <option value="ep">EP</option>
                        <option value="singles">Singles</option>
                    </select>
                </div>
                <div>
                    <label>Number of Masters *</label>
                    <input type="number" id="initialMasters" value="12" min="1" required>
                </div>
                <div>
                    <label>Territory</label>
                    <select id="territory">
                        <option value="universe">The Universe</option>
                        <option value="custom">Custom (specify)</option>
                    </select>
                </div>
                <div id="customTerritoryDiv" style="display:none;">
                    <label>Custom Territory</label>
                    <input type="text" id="customTerritory" placeholder="e.g., The Universe ex-Canada">
                </div>
            </div>
            <div class="form-row">
                <div>
                    <label>Number of Option Periods</label>
                    <input type="number" id="optionPeriods" value="1" min="0">
                </div>
                <div>
                    <label>Masters per Option</label>
                    <input type="number" id="optionMasters" value="12" min="1">
                </div>
                <div>
                    <label>Catalog Acquisition</label>
                    <select id="catalogAcquisition">
                        <option value="no">No</option>
                        <option value="yes">Yes - Specify Songs</option>
                    </select>
                </div>
                <div id="catalogSongsDiv" style="display:none;">
                    <label>Catalog Songs</label>
                    <input type="text" id="catalogSongs" placeholder='e.g., "Song Title 1", "Song Title 2"'>
                    <div class="info-text">List the song titles</div>
                </div>
            </div>
        </div>
        
        <div class="form-section">
            <h3>Financial Terms</h3>
            <div class="form-row">
                <div>
                    <label>Total Advance ($) *</label>
                    <input type="number" id="totalAdvance" value="10000" min="0" required>
                    <div class="info-text">Will be split into three payments</div>
                </div>
                <div>
                    <label>Recording Budget ($) *</label>
                    <input type="number" id="recordingBudget" value="10000" min="0" required>
                </div>
                <div>
                    <label>Marketing Budget ($) *</label>
                    <input type="number" id="marketingBudget" value="10000" min="0" required>
                </div>
            </div>
        </div>
        
        <div class="form-section">
            <h3>Profit Shares & Rights</h3>
            <div class="form-row">
                <div>
                    <label>Net Profit Share (%) *</label>
                    <input type="number" id="netProfit" value="50" min="0" max="100" required>
                </div>
                <div>
                    <label>Sync License Share (%) *</label>
                    <input type="number" id="syncProfit" value="50" min="0" max="100" required>
                </div>
                <div>
                    <label>Merchandise Revenue Share (%)</label>
                    <input type="number" id="merchShare" placeholder="Leave blank if N/A" min="0" max="100">
                    <div class="info-text">Leave blank if no merch deal</div>
                </div>
            </div>
        </div>
        
        <div class="form-section">
            <h3>Term & Licensing</h3>
            <div class="form-row">
                <div>
                    <label>Exclusive Period (months) *</label>
                    <input type="number" id="exclusivePeriod" value="6" min="1" required>
                    <div class="info-text">After last release</div>
                </div>
                <div>
                    <label>Licensing Period (years) *</label>
                    <input type="number" id="licensingYears" value="25" min="1" required>
                </div>
                <div>
                    <label>First Negotiation Period</label>
                    <select id="firstNegotiationPeriod">
                        <option value="3">3 months</option>
                        <option value="6" selected>6 months</option>
                    </select>
                    <div class="info-text">After term ends</div>
                </div>
            </div>
            <div class="form-row">
                <div>
                    <label>Exclusive Negotiation (days) *</label>
                    <input type="number" id="negotiationDays" value="60" min="1" required>
                </div>
                <div>
                    <label>Matching Rights (business days) *</label>
                    <input type="number" id="matchingDays" value="15" min="1" required>
                </div>
            </div>
        </div>
        
        <div class="form-section">
            <h3>Signatory</h3>
            <div class="form-row">
                <div>
                    <label>Signed By</label>
                    <input type="text" id="signatory" value="Christopher Blackwell">
                </div>
            </div>
        </div>
        
        <div class="button-group">
            <button id="generatePdfBtn">Generate Deal Memo PDF</button>
            <button class="copy-btn" id="copyBtn">Generate & Copy Text</button>
            <button class="google-btn" id="createGoogleDocBtn">Create Google Doc</button>
        </div>
        
        <div id="output"></div>
    </div>
    
    <script>
        // Google API Configuration
        const CLIENT_ID = '464744009556-3cuv6q0s1tlvta2ig8rp61g6bkfm7v7k.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyCZcBYSS2Mkh2bRaISVdKLmLtwGD8PjIkQ';
        const DISCOVERY_DOCS = ['https://docs.googleapis.com/$discovery/rest?version=v1'];
        const SCOPES = 'https://www.googleapis.com/auth/documents https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/userinfo.email';
        
        let tokenClient;
        let accessToken = null;
        let currentUser = null;
        
        // Initialize Google Sign-In
        function initializeGoogleSignIn() {
            try {
                // Check if Google Identity Services is loaded
                if (typeof google !== 'undefined' && google.accounts) {
                    google.accounts.id.initialize({
                        client_id: CLIENT_ID,
                        callback: handleCredentialResponse,
                        auto_select: false,
                        cancel_on_tap_outside: true,
                    });
                    
                    google.accounts.id.renderButton(
                        document.getElementById("googleSignInDiv"),
                        { 
                            theme: "filled_blue", 
                            size: "large",
                            text: "sign_in_with",
                            shape: "rectangular",
                            width: 300
                        }
                    );
                    
                    // Initialize token client for additional scopes
                    tokenClient = google.accounts.oauth2.initTokenClient({
                        client_id: CLIENT_ID,
                        scope: SCOPES,
                        callback: (response) => {
                            accessToken = response.access_token;
                        },
                    });
                } else {
                    // Show fallback button if Google Sign-In doesn't load
                    console.log('Google Sign-In not loaded, showing fallback button');
                    document.getElementById('fallbackSignIn').style.display = 'block';
                }
            } catch (error) {
                console.error('Error initializing Google Sign-In:', error);
                document.getElementById('fallbackSignIn').style.display = 'block';
            }
        }
        
        // Handle Google Sign-In response
        function handleCredentialResponse(response) {
            // Decode JWT to get user info
            const responsePayload = decodeJwtResponse(response.credential);
            
            // Check if email domain is @sincerely-yours.xyz
            const email = responsePayload.email;
            const emailDomain = email.split('@')[1];
            
            if (emailDomain !== 'sincerely-yours.xyz') {
                showLoginError(`Access denied. This tool is only available to Sincerely Yours team members. You are signed in as ${email}`);
                return;
            }
            
            // User is authorized
            currentUser = {
                email: email,
                name: responsePayload.name,
                picture: responsePayload.picture
            };
            
            // Request additional permissions for Google Docs
            tokenClient.requestAccessToken();
            
            // Show the main app
            showMainApp();
        }
        
        // Decode JWT token
        function decodeJwtResponse(token) {
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            
            return JSON.parse(jsonPayload);
        }
        
        // Show main app after successful authentication
        function showMainApp() {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('mainContainer').classList.add('authenticated');
            document.getElementById('userEmail').textContent = currentUser.email;
        }
        
        // Show login error
        function showLoginError(message) {
            const errorDiv = document.getElementById('loginError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 10000);
        }
        
        // Sign out
        function signOut() {
            google.accounts.id.disableAutoSelect();
            currentUser = null;
            accessToken = null;
            document.getElementById('mainContainer').classList.remove('authenticated');
            document.getElementById('loginContainer').style.display = 'block';
            
            // Clear form data
            document.getElementById('artistName').value = '';
            document.getElementById('email').value = '';
            
            // Revoke token if exists
            if (accessToken) {
                google.accounts.oauth2.revoke(accessToken);
            }
        }
        
        // Show success message
        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 5000);
        }
        
        // Show error message
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }
        
        // Create Google Doc
        async function createGoogleDoc() {
            if (!accessToken) {
                showError('Please re-authenticate to create Google Docs');
                tokenClient.requestAccessToken();
                return;
            }
            
            const memoText = buildMemoText();
            if (!memoText) return;
            
            const artistName = document.getElementById('artistName').value;
            const date = document.getElementById('date').value;
            const docTitle = `Deal Memo - ${artistName} - ${date}`;
            
            try {
                // Create a new Google Doc
                const createResponse = await fetch('https://docs.googleapis.com/v1/documents', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        title: docTitle
                    })
                });
                
                if (!createResponse.ok) {
                    throw new Error('Failed to create document');
                }
                
                const doc = await createResponse.json();
                const documentId = doc.documentId;
                
                // Format the content for Google Docs
                const requests = formatMemoForGoogleDocs(memoText);
                
                // Update the document with content
                const updateResponse = await fetch(`https://docs.googleapis.com/v1/documents/${documentId}:batchUpdate`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        requests: requests
                    })
                });
                
                if (!updateResponse.ok) {
                    throw new Error('Failed to update document');
                }
                
                // Open the document in a new tab
                const docUrl = `https://docs.google.com/document/d/${documentId}/edit`;
                window.open(docUrl, '_blank');
                
                showSuccess(`Google Doc created successfully! Opening in new tab...`);
                
            } catch (error) {
                console.error('Error creating Google Doc:', error);
                showError('Failed to create Google Doc. Please try again.');
            }
        }
        
        // Format memo text for Google Docs API
        function formatMemoForGoogleDocs(memoText) {
            const requests = [];
            let insertIndex = 1;
            
            requests.push({
                insertText: {
                    location: { index: insertIndex },
                    text: memoText
                }
            });
            
            const lines = memoText.split('\n');
            let currentIndex = 1;
            
            lines.forEach(line => {
                if (line.match(/^\d+\./)) {
                    const match = line.match(/^(\d+\.\s)([^:]+:)/);
                    if (match) {
                        const numberLength = match[1].length;
                        const labelLength = match[2].length;
                        
                        requests.push({
                            updateTextStyle: {
                                range: {
                                    startIndex: currentIndex + numberLength,
                                    endIndex: currentIndex + numberLength + labelLength
                                },
                                textStyle: {
                                    bold: true
                                },
                                fields: 'bold'
                            }
                        });
                    }
                }
                currentIndex += line.length + 1;
            });
            
            return requests;
        }
        
        // Update deal type
        document.getElementById('dealType').addEventListener('change', function() {
            const dealType = this.value;
            const mastersField = document.getElementById('initialMasters');
            const optionMastersField = document.getElementById('optionMasters');
            
            if (dealType === 'ep') {
                mastersField.value = '8';
                optionMastersField.value = '8';
            } else if (dealType === 'album') {
                mastersField.value = '12';
                optionMastersField.value = '12';
            } else {
                mastersField.value = '5';
                optionMastersField.value = '5';
            }
        });
        
        // Toggle catalog songs
        document.getElementById('catalogAcquisition').addEventListener('change', function() {
            const catalogDiv = document.getElementById('catalogSongsDiv');
            if (this.value === 'yes') {
                catalogDiv.style.display = 'block';
            } else {
                catalogDiv.style.display = 'none';
            }
        });
        
        // Toggle custom territory
        document.getElementById('territory').addEventListener('change', function() {
            const customDiv = document.getElementById('customTerritoryDiv');
            if (this.value === 'custom') {
                customDiv.style.display = 'block';
            } else {
                customDiv.style.display = 'none';
            }
        });
        
        // Format number with dollar sign
        function formatNumber(num) {
            return '$' + parseInt(num).toLocaleString();
        }
        
        // Format date
        function formatDate(dateString) {
            const date = new Date(dateString);
            const months = ['January', 'February', 'March', 'April', 'May', 'June', 
                          'July', 'August', 'September', 'October', 'November', 'December'];
            const day = date.getDate();
            return `${months[date.getMonth()]} ${day}, ${date.getFullYear()}`;
        }
        
        // Build memo text for display/copy
        function buildMemoText() {
            // Get all values
            const artistName = document.getElementById('artistName').value;
            const date = document.getElementById('date').value;
            const email = document.getElementById('email').value;
            const dealType = document.getElementById('dealType').value;
            const initialMasters = document.getElementById('initialMasters').value;
            const optionPeriods = document.getElementById('optionPeriods').value;
            const optionMasters = document.getElementById('optionMasters').value;
            const totalAdvance = document.getElementById('totalAdvance').value;
            const recordingBudget = document.getElementById('recordingBudget').value;
            const marketingBudget = document.getElementById('marketingBudget').value;
            const netProfit = document.getElementById('netProfit').value;
            const syncProfit = document.getElementById('syncProfit').value;
            const merchShare = document.getElementById('merchShare').value;
            const exclusivePeriod = document.getElementById('exclusivePeriod').value;
            const licensingYears = document.getElementById('licensingYears').value;
            const negotiationDays = document.getElementById('negotiationDays').value;
            const matchingDays = document.getElementById('matchingDays').value;
            const signatory = document.getElementById('signatory').value;
            const firstNegotiationPeriod = document.getElementById('firstNegotiationPeriod').value;
            const territory = document.getElementById('territory').value;
            const customTerritory = document.getElementById('customTerritory').value;
            const catalogAcquisition = document.getElementById('catalogAcquisition').value;
            const catalogSongs = document.getElementById('catalogSongs').value;
            
            // Validation
            if (!artistName) {
                alert('Please enter the artist name');
                return null;
            }
            
            // Calculate payment schedule
            const advanceAmount = parseInt(totalAdvance);
            const firstThird = Math.floor(advanceAmount / 3);
            const secondThird = Math.floor(advanceAmount / 3);
            const finalThird = advanceAmount - firstThird - secondThird;
            
            // Format all the fields
            const territoryText = territory === 'custom' && customTerritory ? customTerritory : "The Universe";
            const dealTypeText = dealType === 'album' ? 'one studio album' : 
                                dealType === 'ep' ? 'one EP' : 
                                `${initialMasters} singles`;
            
            // Format numbers as word (number)
            const numberToWord = (num) => {
                const numbers = {
                    '1': 'one', '2': 'two', '3': 'three', '4': 'four', '5': 'five',
                    '6': 'six', '7': 'seven', '8': 'eight', '9': 'nine', '10': 'ten',
                    '11': 'eleven', '12': 'twelve', '15': 'fifteen', '20': 'twenty',
                    '25': 'twenty-five', '30': 'thirty', '60': 'sixty', '90': 'ninety'
                };
                return numbers[num] ? `${numbers[num]} (${num})` : `${num}`;
            };
            
            const mastersText = numberToWord(initialMasters);
            const optionMastersText = numberToWord(optionMasters);
            
            let catalogText = '';
            if (catalogAcquisition === 'yes' && catalogSongs) {
                catalogText = `, together with ${catalogSongs}`;
            }
            
            let optionText = '';
            if (parseInt(optionPeriods) > 0) {
                const optionWord = parseInt(optionPeriods) === 1 ? 'one (1) option' : `${numberToWord(optionPeriods)} options`;
                optionText = `, with ${optionWord} to enter into additional recording commitments with Artist, with ${optionMastersText} Masters to be delivered in respect of each option`;
            }
            
            const merchText = merchShare ? ` Additionally, ${merchShare}% of Net Profits in connection with merchandise revenue.` : '';
            const profitsSection = `${netProfit}% of Net Profits (to be defined in the Agreement) in connection with the Masters, and ${syncProfit}% of Net Profits in connection with revenue collected from third party sync licenses.${merchText} Unless otherwise agreed between the parties in writing, you will be responsible for paying all producers, mixers and side artists in connection with the Masters.`;
            
            // Build the complete memo (US version)
            const memo = `                    ${formatDate(date)}

Sincerely Yours Media LLC
12130 Millennium Dr.
Los Angeles, CA 90094

${artistName}
${email ? `VIA EMAIL: ${email}` : 'VIA EMAIL'}

Re: Deal Memo

Dear ${artistName}:

This proposal sets forth the material terms pursuant to which Sincerely Yours Media LLC ("us" or "Sincerely Yours") will enter into an agreement (the "Agreement") with you.

1. Territory: ${territoryText}.

2. Exclusive Period: Begins on the Effective Date (to be defined in the Agreement) and continues until ${numberToWord(exclusivePeriod)} ${exclusivePeriod == '1' ? 'month' : 'months'} from the release date of the last Master released under the Agreement (the "Term").

3. Recording Commitment: You will deliver ${mastersText} Masters${catalogText} (the "Recording Commitment")${optionText}.

4. Artist Advance: ${formatNumber(totalAdvance)} for the initial period to be paid to you as follows:
   â€¢ ${formatNumber(firstThird)} upon signing of the Agreement
   â€¢ ${formatNumber(secondThird)} upon commencement of recording the Recording Commitment
   â€¢ ${formatNumber(finalThird)} upon commercial release of the Recording Commitment

5. Recording Budget: In addition, Sincerely Yours would make available a budget of up to ${formatNumber(recordingBudget)} (the "Recording Budget") to be used in connection with recording costs, which amount would be administered by Sincerely Yours. The Recording Budget will be deemed a recoupable advance against your share of Net Profits.

6. Marketing Fund: ${formatNumber(marketingBudget)} drawdown fund (the "Marketing Fund") to be used, at our sole discretion, for marketing, advertising and promotion costs in connection with the Recording Commitment. The Marketing Fund will be deemed a recoupable advance against your share of Net Profits.

7. Profits: ${profitsSection}

8. Accounting: Semi-annually, within 90 days of the applicable accounting period.

9. Rights/Licensing Period: Sincerely Yours shall have the exclusive right during the Licensing Period (defined below) to exploit the Masters made during and/or prior to the Term and delivered during the Term. "Licensing Period" means the period commencing on the Effective Date and continues until the later of: (A) ${numberToWord(licensingYears)} years following the commencement of the Term; or (B) the end of the semi-annual accounting period during which your royalty account became fully recouped.

10. First Negotiation/Matching Right: During the Term, and for a period of ${numberToWord(firstNegotiationPeriod)} months following the expiration or termination of the Term, prior to entering into negotiations with any third party with respect to your recording services and/or the rights in and to the masters, you shall first notify Sincerely Yours that you would like to negotiate such an agreement, after which you shall negotiate with Sincerely Yours exclusively for ${numberToWord(negotiationDays)} days.

    a. If, by the expiration of such ${negotiationDays}-day period, no agreement is reached between you and us, you may negotiate with third parties an agreement with respect to your recording services and/or the right to exploit Masters, but may not enter into an agreement with any third party other than Sincerely Yours unless you first: (i) notify Sincerely Yours in writing of the material terms of the proposed agreement pursuant to which such rights are to be granted and the identities of all proposed parties to such agreement ("Third-Party Offer"); and (ii) offer to enter into an agreement with Sincerely Yours on the same material financial terms as the Third-Party Offer ("Matching Right").

    b. If Sincerely Yours does not accept the third-party offer within ${numberToWord(matchingDays)} business days after Sincerely Yours receive such third-party offer, you may then enter into the agreement set forth in the third-party offer, provided that such agreement is consummated upon the same or better terms (for you) and in the same form set forth in the third-party offer.

Please note that I must reserve the right for Sincerely Yours senior management to modify the terms suggested herein.

Very truly yours,

${signatory}`;
            
            return memo;
        }
        
        // Generate PDF
        function generateMemo() {
            const memoText = buildMemoText();
            if (!memoText) return;
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // PDF generation settings
            const leftMargin = 25;
            const rightMargin = 25;
            const topMargin = 25;
            const bottomMargin = 25;
            const pageWidth = doc.internal.pageSize.width;
            const pageHeight = doc.internal.pageSize.height;
            const contentWidth = pageWidth - leftMargin - rightMargin;
            
            let yPos = topMargin;
            const lineHeight = 5;
            const paragraphSpacing = 8;
            
            // Set font
            doc.setFontSize(11);
            doc.setFont("helvetica", "normal");
            
            // Process text line by line
            const lines = memoText.split('\n');
            
            lines.forEach((line, index) => {
                // Check if we need a new page
                if (yPos > pageHeight - bottomMargin) {
                    doc.addPage();
                    yPos = topMargin;
                }
                
                // Handle date line (right-aligned)
                if (line.includes('                    ') && index === 0) {
                    doc.setFont("helvetica", "normal");
                    const dateText = line.trim();
                    const dateWidth = doc.getTextWidth(dateText);
                    doc.text(dateText, pageWidth - rightMargin - dateWidth, yPos);
                    yPos += lineHeight * 2;
                }
                // Handle bold headers
                else if (line.match(/^\d+\./)) {
                    yPos += paragraphSpacing;
                    doc.setFont("helvetica", "bold");
                    const colonIndex = line.indexOf(':');
                    if (colonIndex > -1) {
                        const boldPart = line.substring(0, colonIndex + 1);
                        const regularPart = line.substring(colonIndex + 1);
                        doc.text(boldPart, leftMargin, yPos);
                        doc.setFont("helvetica", "normal");
                        const boldWidth = doc.getTextWidth(boldPart);
                        const splitText = doc.splitTextToSize(regularPart, contentWidth - boldWidth);
                        if (splitText.length > 0) {
                            doc.text(splitText[0], leftMargin + boldWidth, yPos);
                            for (let i = 1; i < splitText.length; i++) {
                                yPos += lineHeight;
                                if (yPos > pageHeight - bottomMargin) {
                                    doc.addPage();
                                    yPos = topMargin;
                                }
                                doc.text(splitText[i], leftMargin, yPos);
                            }
                        }
                    } else {
                        doc.text(line, leftMargin, yPos);
                    }
                    yPos += lineHeight;
                }
                // Handle bullet points
                else if (line.trim().startsWith('â€¢')) {
                    doc.setFont("helvetica", "normal");
                    const splitText = doc.splitTextToSize(line.trim(), contentWidth - 10);
                    splitText.forEach((textLine, i) => {
                        if (yPos > pageHeight - bottomMargin) {
                            doc.addPage();
                            yPos = topMargin;
                        }
                        doc.text(textLine, leftMargin + 10, yPos);
                        yPos += lineHeight;
                    });
                }
                // Handle sub-items
                else if (line.trim().match(/^\s*[ab]\./)) {
                    doc.setFont("helvetica", "normal");
                    const splitText = doc.splitTextToSize(line.trim(), contentWidth - 20);
                    splitText.forEach((textLine, i) => {
                        if (yPos > pageHeight - bottomMargin) {
                            doc.addPage();
                            yPos = topMargin;
                        }
                        doc.text(textLine, leftMargin + 20, yPos);
                        yPos += lineHeight;
                    });
                }
                // Handle empty lines
                else if (line.trim() === '') {
                    yPos += lineHeight * 0.5;
                }
                // Handle regular text
                else if (line.trim()) {
                    const splitText = doc.splitTextToSize(line, contentWidth);
                    splitText.forEach((textLine) => {
                        if (yPos > pageHeight - bottomMargin) {
                            doc.addPage();
                            yPos = topMargin;
                        }
                        doc.text(textLine, leftMargin, yPos);
                        yPos += lineHeight;
                    });
                }
            });
            
            // Save the PDF
            const artistName = document.getElementById('artistName').value.replace(/\s+/g, '_');
            const date = document.getElementById('date').value;
            const filename = `Deal_Memo_${artistName}_${date}.pdf`;
            doc.save(filename);
        }
        
        // Generate and copy text
        function generateAndCopy() {
            const memoText = buildMemoText();
            if (!memoText) return;
            
            const outputDiv = document.getElementById('output');
            outputDiv.textContent = memoText;
            outputDiv.style.display = 'block';
            
            navigator.clipboard.writeText(memoText).then(() => {
                showSuccess('Deal memo copied to clipboard!');
            }).catch(err => {
                const textArea = document.createElement("textarea");
                textArea.value = memoText;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showSuccess('Deal memo copied to clipboard!');
            });
        }
        
        // Set up when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Set today's date
            document.getElementById('date').valueAsDate = new Date();
            
            // Wait for Google Sign-In to load, then initialize
            if (typeof google !== 'undefined') {
                initializeGoogleSignIn();
            } else {
                // Try again after a short delay
                setTimeout(() => {
                    initializeGoogleSignIn();
                }, 1000);
                
                // And show fallback button as backup
                setTimeout(() => {
                    if (!document.querySelector('#googleSignInDiv iframe')) {
                        document.getElementById('fallbackSignIn').style.display = 'block';
                    }
                }, 2000);
            }
            
            // Load Google API
            if (typeof gapi !== 'undefined') {
                gapi.load('client', () => {
                    gapi.client.init({
                        apiKey: API_KEY,
                        discoveryDocs: DISCOVERY_DOCS,
                    });
                });
            }
            
            // Attach button handlers
            document.getElementById('generatePdfBtn').addEventListener('click', generateMemo);
            document.getElementById('copyBtn').addEventListener('click', generateAndCopy);
            document.getElementById('createGoogleDocBtn').addEventListener('click', createGoogleDoc);
            document.getElementById('signOutBtn').addEventListener('click', signOut);
            
            // Fallback button handler
            document.getElementById('fallbackSignIn').addEventListener('click', () => {
                // Try to initialize Google Sign-In again
                initializeGoogleSignIn();
                // If still not available, use OAuth2 flow
                if (tokenClient) {
                    tokenClient.requestAccessToken();
                } else {
                    showLoginError('Unable to load Google Sign-In. Please refresh the page and try again.');
                }
            });
        });
    </script>
</body>
</html>
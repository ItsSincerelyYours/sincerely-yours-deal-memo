<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sincerely Yours Media - Deal Memo Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            border-bottom: 3px solid #6B46C1;
            padding-bottom: 10px;
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 20px;
            font-style: italic;
        }
        
        .google-status {
            padding: 10px;
            margin: 20px 0;
            border-radius: 5px;
            background: #f0f0f0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .google-status.connected {
            background: #d4edda;
            color: #155724;
        }
        
        .form-section {
            margin: 20px 0;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 5px;
            border-left: 4px solid #6B46C1;
        }
        
        .form-section h3 {
            margin-top: 0;
            color: #555;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #666;
            font-size: 13px;
        }
        
        input, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        select {
            cursor: pointer;
        }
        
        button {
            background: #6B46C1;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 20px;
            font-weight: bold;
        }
        
        button:hover {
            background: #553396;
        }
        
        .google-btn {
            background: #4285f4;
        }
        
        .google-btn:hover {
            background: #357ae8;
        }
        
        #output {
            margin-top: 30px;
            padding: 25px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 5px;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            line-height: 1.6;
            display: none;
            font-size: 13px;
        }
        
        .copy-btn {
            background: #2196F3;
            margin-left: 10px;
        }
        
        .copy-btn:hover {
            background: #0b7dda;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .info-text {
            color: #888;
            font-size: 12px;
            font-style: italic;
            margin-top: 3px;
        }
        
        .success-message {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 12px;
            border-radius: 4px;
            margin: 15px 0;
            display: none;
        }
        
        .error-message {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 12px;
            border-radius: 4px;
            margin: 15px 0;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìÑ Sincerely Yours Media - Deal Memo Generator</h1>
        <div class="subtitle">Recording Agreement Deal Memo Template with Google Docs Integration</div>
        
        <div class="google-status" id="googleStatus">
            <span>üîê</span>
            <span id="statusText">Not authenticated</span>
            <button id="googleSignIn" class="google-btn" style="margin: 0; padding: 8px 20px;">Sign in with Google</button>
        </div>
        
        <div class="success-message" id="successMessage"></div>
        <div class="error-message" id="errorMessage"></div>
        
        <div id="authRequired" style="padding: 40px; text-align: center; background: #f9f9f9; border-radius: 10px; margin: 30px 0;">
            <h2 style="color: #6B46C1;">Authentication Required</h2>
            <p style="color: #666; margin: 20px 0;">Please sign in with your Sincerely Yours Google account to access the Deal Memo Generator.</p>
            <p style="color: #999; font-size: 14px;">Access is restricted to @sincerely-yours.xyz email accounts.</p>
        </div>
        
        <div id="formContainer" style="display: none;">
        <div class="form-section">
            <h3>Basic Information</h3>
            <div class="form-row">
                <div>
                    <label>Artist Professional Name *</label>
                    <input type="text" id="artistName" placeholder="e.g., Day Lee" required>
                </div>
                <div>
                    <label>Agreement Date *</label>
                    <input type="date" id="date" required>
                </div>
            </div>
        </div>
        
        <div class="form-section">
            <h3>Deal Structure</h3>
            <div class="form-row">
                <div>
                    <label>Deal Type *</label>
                    <select id="dealType">
                        <option value="album">Studio Album</option>
                        <option value="ep">EP</option>
                        <option value="singles">Singles</option>
                    </select>
                </div>
                <div>
                    <label>Number of Masters *</label>
                    <input type="number" id="initialMasters" value="12" min="1" required>
                </div>
                <div>
                    <label>Territory</label>
                    <select id="territory">
                        <option value="universe">The Universe</option>
                        <option value="custom">Custom (specify)</option>
                    </select>
                </div>
                <div id="customTerritoryDiv" style="display:none;">
                    <label>Custom Territory</label>
                    <input type="text" id="customTerritory" placeholder="e.g., The Universe ex-Canada">
                </div>
            </div>
            <div class="form-row">
                <div>
                    <label>Number of Option Periods</label>
                    <input type="number" id="optionPeriods" value="1" min="0">
                </div>
                <div>
                    <label>Masters per Option</label>
                    <input type="number" id="optionMasters" value="12" min="1">
                </div>
                <div>
                    <label>Catalog Acquisition</label>
                    <select id="catalogAcquisition">
                        <option value="no">No</option>
                        <option value="yes">Yes - Specify Songs</option>
                    </select>
                </div>
                <div id="catalogSongsDiv" style="display:none;">
                    <label>Catalog Songs</label>
                    <input type="text" id="catalogSongs" placeholder='e.g., all prior recordings'>
                    <div class="info-text">Describe the catalog songs</div>
                </div>
            </div>
        </div>
        
        <div class="form-section">
            <h3>Financial Terms</h3>
            <div class="form-row">
                <div>
                    <label>Artist Advance ($) *</label>
                    <input type="number" id="totalAdvance" value="25000" min="0" required>
                    <div class="info-text">Will be split into thirds</div>
                </div>
                <div>
                    <label>Recording Budget ($) *</label>
                    <input type="number" id="recordingBudget" value="25000" min="0" required>
                </div>
                <div>
                    <label>Marketing Budget ($) *</label>
                    <input type="number" id="marketingBudget" value="30000" min="0" required>
                </div>
            </div>
        </div>
        
        <div class="form-section">
            <h3>Profit Shares & Rights</h3>
            <div class="form-row">
                <div>
                    <label>Net Profit Share (%) *</label>
                    <input type="number" id="netProfit" value="40" min="0" max="100" required>
                </div>
                <div>
                    <label>Sync License Share (%) *</label>
                    <input type="number" id="syncProfit" value="50" min="0" max="100" required>
                </div>
                <div>
                    <label>Merchandise Revenue Share (%)</label>
                    <input type="number" id="merchShare" placeholder="Leave blank if N/A" min="0" max="100">
                    <div class="info-text">Leave blank if no merch deal</div>
                </div>
            </div>
        </div>
        
        <div class="form-section">
            <h3>Term & Licensing</h3>
            <div class="form-row">
                <div>
                    <label>Exclusive Period (months) *</label>
                    <input type="number" id="exclusivePeriod" value="6" min="1" required>
                    <div class="info-text">After last release</div>
                </div>
                <div>
                    <label>Licensing Period (years) *</label>
                    <input type="number" id="licensingYears" value="25" min="1" required>
                </div>
                <div>
                    <label>First Negotiation Period</label>
                    <select id="firstNegotiationPeriod">
                        <option value="3">3 months</option>
                        <option value="6" selected>6 months</option>
                    </select>
                    <div class="info-text">After term ends</div>
                </div>
            </div>
            <div class="form-row">
                <div>
                    <label>Exclusive Negotiation (days) *</label>
                    <input type="number" id="negotiationDays" value="60" min="1" required>
                </div>
                <div>
                    <label>Matching Rights (business days) *</label>
                    <input type="number" id="matchingDays" value="15" min="1" required>
                </div>
            </div>
        </div>
        
        <div class="form-section">
            <h3>Signatory</h3>
            <div class="form-row">
                <div>
                    <label>Signed By</label>
                    <input type="text" id="signatory" value="Lynn Gonzalez">
                </div>
            </div>
        </div>
        
        <div class="button-group">
            <button id="generatePdfBtn">Generate Deal Memo PDF</button>
            <button class="copy-btn" id="copyBtn">Generate & Copy Text</button>
            <button class="google-btn" id="createGoogleDocBtn">Create Google Doc</button>
        </div>
        
        <div id="output"></div>
        </div>
    </div>
    
    <script>
        // Google API Configuration
        const CLIENT_ID = '464744009556-3cuv6q0s1tlvta2ig8rp61g6bkfm7v7k.apps.googleusercontent.com'; // Your Client ID
        const API_KEY = 'PASTE_YOUR_API_KEY_HERE'; // Replace with your actual API Key
        const DISCOVERY_DOCS = ['https://docs.googleapis.com/$discovery/rest?version=v1'];
        const SCOPES = 'https://www.googleapis.com/auth/documents https://www.googleapis.com/auth/drive.file';
        
        let tokenClient;
        let accessToken = null;
        
        // Initialize Google API
        function initializeGoogleAPI() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES + ' https://www.googleapis.com/auth/userinfo.email',
                callback: async (response) => {
                    accessToken = response.access_token;
                    // Verify user email domain
                    try {
                        const userResponse = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
                            headers: {
                                'Authorization': `Bearer ${accessToken}`
                            }
                        });
                        const userInfo = await userResponse.json();
                        
                        if (userInfo && userInfo.email) {
                            const emailDomain = userInfo.email.split('@')[1];
                            if (emailDomain === 'sincerely-yours.xyz') {
                                updateGoogleStatus(true);
                                showSuccess('Welcome to Sincerely Yours Deal Memo Generator!');
                                document.getElementById('formContainer').style.display = 'block';
                                document.getElementById('authRequired').style.display = 'none';
                            } else {
                                showError('Access denied. This tool is only available to Sincerely Yours team members.');
                                google.accounts.oauth2.revoke(accessToken);
                                accessToken = null;
                                updateGoogleStatus(false);
                            }
                        }
                    } catch (error) {
                        console.error('Error verifying user:', error);
                        showError('Failed to verify user. Please try again.');
                    }
                },
            });
        }
        
        // Handle Google Sign In
        document.getElementById('googleSignIn').addEventListener('click', () => {
            if (accessToken === null) {
                tokenClient.requestAccessToken();
            } else {
                google.accounts.oauth2.revoke(accessToken, () => {
                    accessToken = null;
                    updateGoogleStatus(false);
                });
            }
        });
        
        // Update Google connection status
        function updateGoogleStatus(connected) {
            const statusDiv = document.getElementById('googleStatus');
            const statusText = document.getElementById('statusText');
            const signInBtn = document.getElementById('googleSignIn');
            
            if (connected) {
                statusDiv.classList.add('connected');
                statusText.textContent = 'Authenticated';
                signInBtn.textContent = 'Sign Out';
            } else {
                statusDiv.classList.remove('connected');
                statusText.textContent = 'Not authenticated';
                signInBtn.textContent = 'Sign in with Google';
                document.getElementById('formContainer').style.display = 'none';
                document.getElementById('authRequired').style.display = 'block';
            }
        }
        
        // Show success message
        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 5000);
        }
        
        // Show error message
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }
        
        // Create Google Doc
        async function createGoogleDoc() {
            if (!accessToken) {
                showError('Please connect your Google account first');
                return;
            }
            
            const memoText = buildMemoText();
            if (!memoText) return;
            
            const artistName = document.getElementById('artistName').value;
            const date = document.getElementById('date').value;
            const docTitle = `${artistName} x Sincerely Yours Deal Memo`;
            
            try {
                // Create a new Google Doc
                const createResponse = await fetch('https://docs.googleapis.com/v1/documents', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        title: docTitle
                    })
                });
                
                if (!createResponse.ok) {
                    throw new Error('Failed to create document');
                }
                
                const doc = await createResponse.json();
                const documentId = doc.documentId;
                
                // Format the content for Google Docs
                const requests = formatMemoForGoogleDocs(memoText);
                
                // Update the document with content
                const updateResponse = await fetch(`https://docs.googleapis.com/v1/documents/${documentId}:batchUpdate`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        requests: requests
                    })
                });
                
                if (!updateResponse.ok) {
                    throw new Error('Failed to update document');
                }
                
                // Open the document in a new tab
                const docUrl = `https://docs.google.com/document/d/${documentId}/edit`;
                window.open(docUrl, '_blank');
                
                showSuccess(`Google Doc created successfully! Opening in new tab...`);
                
            } catch (error) {
                console.error('Error creating Google Doc:', error);
                showError('Failed to create Google Doc. Please try again.');
            }
        }
        
        // Format memo text for Google Docs API
        function formatMemoForGoogleDocs(memoText) {
            // Clean up the markdown-style formatting for Google Docs
            const cleanedText = memoText
                .replace(/\*\*__(.+?)__\*\*/g, '$1')  // Remove **__ and __** markers
                .replace(/\*(.+?)\*/g, '$1')  // Remove * markers for italics
                .replace(/\*\*/g, '');  // Remove any remaining ** markers
            
            const requests = [];
            let insertIndex = 1;
            
            // Insert all cleaned text first
            requests.push({
                insertText: {
                    location: { index: insertIndex },
                    text: cleanedText
                }
            });
            
            // Now add formatting
            const lines = cleanedText.split('\n');
            let currentIndex = 1;
            
            lines.forEach((line, lineIndex) => {
                // Format the header (first line - Sincerely Yours Media LLC)
                if (lineIndex === 0 && line.includes('Sincerely Yours Media LLC')) {
                    // Make it bold and underlined
                    requests.push({
                        updateTextStyle: {
                            range: {
                                startIndex: currentIndex,
                                endIndex: currentIndex + line.length
                            },
                            textStyle: {
                                bold: true,
                                underline: true
                            },
                            fields: 'bold,underline'
                        }
                    });
                    // Center align this line
                    requests.push({
                        updateParagraphStyle: {
                            range: {
                                startIndex: currentIndex,
                                endIndex: currentIndex + line.length
                            },
                            paragraphStyle: {
                                alignment: 'CENTER'
                            },
                            fields: 'alignment'
                        }
                    });
                }
                
                // Center align the other header lines (c/o, address, city)
                if ((lineIndex === 1 && line.includes('c/o Granderson')) ||
                    (lineIndex === 2 && line.includes('150 S. Rodeo')) ||
                    (lineIndex === 3 && line.includes('Beverly Hills'))) {
                    requests.push({
                        updateParagraphStyle: {
                            range: {
                                startIndex: currentIndex,
                                endIndex: currentIndex + line.length
                            },
                            paragraphStyle: {
                                alignment: 'CENTER'
                            },
                            fields: 'alignment'
                        }
                    });
                }
                
                // Italicize the proposal introduction paragraph
                if (line.includes('This proposal sets forth the material terms')) {
                    requests.push({
                        updateTextStyle: {
                            range: {
                                startIndex: currentIndex,
                                endIndex: currentIndex + line.length
                            },
                            textStyle: {
                                italic: true
                            },
                            fields: 'italic'
                        }
                    });
                }
                
                // Bold section headers (1., 2., etc.)
                if (line.match(/^\d+\./)) {
                    const match = line.match(/^(\d+\.\s)([^:]+:)/);
                    if (match) {
                        const numberLength = match[1].length;
                        const labelLength = match[2].length;
                        
                        requests.push({
                            updateTextStyle: {
                                range: {
                                    startIndex: currentIndex + numberLength,
                                    endIndex: currentIndex + numberLength + labelLength
                                },
                                textStyle: {
                                    bold: true
                                },
                                fields: 'bold'
                            }
                        });
                    }
                }
                
                currentIndex += line.length + 1; // +1 for newline
            });
            
            return requests;
        }
        
        // Existing functions (buildMemoText, etc.) remain the same
        // ... [Include all the existing JavaScript functions from the original file]
        
        // Update deal type
        document.getElementById('dealType').addEventListener('change', function() {
            const dealType = this.value;
            const mastersField = document.getElementById('initialMasters');
            const optionMastersField = document.getElementById('optionMasters');
            
            if (dealType === 'ep') {
                mastersField.value = '8';
                optionMastersField.value = '8';
            } else if (dealType === 'album') {
                mastersField.value = '12';
                optionMastersField.value = '12';
            } else {
                mastersField.value = '5';
                optionMastersField.value = '5';
            }
        });
        
        // Toggle catalog songs
        document.getElementById('catalogAcquisition').addEventListener('change', function() {
            const catalogDiv = document.getElementById('catalogSongsDiv');
            if (this.value === 'yes') {
                catalogDiv.style.display = 'block';
            } else {
                catalogDiv.style.display = 'none';
            }
        });
        
        // Toggle custom territory
        document.getElementById('territory').addEventListener('change', function() {
            const customDiv = document.getElementById('customTerritoryDiv');
            if (this.value === 'custom') {
                customDiv.style.display = 'block';
            } else {
                customDiv.style.display = 'none';
            }
        });
        
        // Format number with dollar sign
        function formatNumber(num) {
            return '$' + parseInt(num).toLocaleString();
        }
        
        // Format date
        function formatDate(dateString) {
            const date = new Date(dateString);
            const months = ['January', 'February', 'March', 'April', 'May', 'June', 
                          'July', 'August', 'September', 'October', 'November', 'December'];
            const day = date.getDate();
            return `${months[date.getMonth()]} ${day}, ${date.getFullYear()}`;
        }
        
        // Build memo text for display/copy
        function buildMemoText() {
            // [Include the complete buildMemoText function from the original file]
            // Get all values
            const artistName = document.getElementById('artistName').value;
            const date = document.getElementById('date').value;
            const dealType = document.getElementById('dealType').value;
            const initialMasters = document.getElementById('initialMasters').value;
            const optionPeriods = document.getElementById('optionPeriods').value;
            const optionMasters = document.getElementById('optionMasters').value;
            const totalAdvance = document.getElementById('totalAdvance').value;
            const recordingBudget = document.getElementById('recordingBudget').value;
            const marketingBudget = document.getElementById('marketingBudget').value;
            const netProfit = document.getElementById('netProfit').value;
            const syncProfit = document.getElementById('syncProfit').value;
            const merchShare = document.getElementById('merchShare').value;
            const exclusivePeriod = document.getElementById('exclusivePeriod').value;
            const licensingYears = document.getElementById('licensingYears').value;
            const negotiationDays = document.getElementById('negotiationDays').value;
            const matchingDays = document.getElementById('matchingDays').value;
            const signatory = document.getElementById('signatory').value;
            const firstNegotiationPeriod = document.getElementById('firstNegotiationPeriod').value;
            const territory = document.getElementById('territory').value;
            const customTerritory = document.getElementById('customTerritory').value;
            const catalogAcquisition = document.getElementById('catalogAcquisition').value;
            const catalogSongs = document.getElementById('catalogSongs').value;
            
            // Validation
            if (!artistName) {
                alert('Please enter the artist name');
                return null;
            }
            
            // Calculate payment schedule
            const advanceAmount = parseInt(totalAdvance);
            const firstThird = Math.ceil(advanceAmount / 3);
            const secondThird = Math.floor(advanceAmount / 3);
            const finalThird = advanceAmount - firstThird - secondThird;
            
            // Format all the fields (same as original)
            const territoryText = territory === 'custom' && customTerritory ? customTerritory : "The Universe";
            const dealTypeText = dealType === 'album' ? 'one studio album' : 
                                dealType === 'ep' ? 'one EP' : 
                                `${initialMasters} singles`;
            const mastersText = initialMasters == '12' ? 'twelve (12)' :
                               initialMasters == '8' ? 'eight (8)' :
                               initialMasters == '5' ? 'five (5)' :
                               initialMasters == '10' ? 'ten (10)' :
                               `${initialMasters}`;
            const optionMastersText = optionMasters == '12' ? 'twelve (12) Masters' :
                                     optionMasters == '8' ? 'eight (8) Masters' :
                                     `${optionMasters} Masters`;
            
            let catalogText = '';
            if (catalogAcquisition === 'yes' && catalogSongs) {
                catalogText = `, together with ${catalogSongs}`;
            }
            
            let optionText = '';
            if (parseInt(optionPeriods) > 0) {
                const optionWord = parseInt(optionPeriods) === 1 ? 'one (1) option' : `${optionPeriods} options`;
                optionText = ` In addition, Sincerely Yours would have ${optionWord} to extend the agreement to include an additional ${optionMastersText} in respect of such option.`;
            }
            
            const merchText = merchShare ? ` Additionally, ${merchShare}% of Net Profits in connection with merchandise revenue.` : '';
            const profitsSection = `${netProfit}% of Net Profits (to be defined in the Agreement) in connection with the Masters, and ${syncProfit}% of Net Profits in connection with revenue collected from third party sync licenses.${merchText} Unless otherwise agreed between the parties in writing, you will be responsible for paying all producers, mixers and side artists in connection with the Masters.`;
            
            // Build the complete memo (same as original)
            const memo = `                                   **__Sincerely Yours Media LLC__**
                                    c/o Granderson Des Rochers LLP
                                       150 S. Rodeo Drive, Suite 300
                                         Beverly Hills, CA 90212


Date: ${formatDate(date)}

*This proposal sets forth the material terms pursuant to which Sincerely Yours Media LLC ("us" or "Sincerely Yours") will enter into an agreement with the recording artist professionally known as "${artistName}" ("you" or "Artist") in respect of master recordings ("Masters") featuring their performance.*

1. Territory: ${territoryText}.

2. Exclusive Period: Begins on the Effective Date (to be defined in the Agreement) and continues until ${exclusivePeriod} months from the release date of the last Master released under the Agreement (the "Term").

3. Delivery Commitment: you will Deliver (to be defined in the Agreement) to Sincerely Yours ${dealTypeText} that includes no less than ${mastersText} Masters${catalogText} (the "Initial Period").${optionText}

4. Advance: Sincerely Yours would pay you an advance of ${formatNumber(totalAdvance)} during each contract period, which amount would be paid to you as follows: one-third (1/3) of the advance (${formatNumber(firstThird)}) upon signing of this agreement for such contract period, one-third (1/3) of the advance (${formatNumber(secondThird)}) following Delivery of cleared records for such contract period, and the final one-third (1/3) of the advance (${formatNumber(finalThird)}) upon commercial release of the recording commitment for such contract period.

5. Recording Costs: Sincerely Yours would make available a budget of up to ${formatNumber(recordingBudget)} to be used in connection with recording costs during each Contract Period, which amount would be administered by Sincerely Yours.

6. Marketing Costs: ${formatNumber(marketingBudget)} drawdown fund (the "Advance") to be used, at our sole discretion, for marketing, advertising and promotion costs in connection with the Recording Commitment during each contract period. The Advance will be deemed a recoupable advance against your share of Net Profits.

7. Profits: ${profitsSection}

8. Accounting: Semi-annually, within 90 days of the applicable accounting period.

9. Rights;Licensing Period: We shall have the exclusive right during the Licensing Period (defined below) to exploit the Masters made during and/or prior to the Term and Delivered during the Term. "Licensing Period" means the period commencing on the Effective Date and continues until the later of: (A) ${licensingYears == '15' ? 'fifteen (15)' : licensingYears == '25' ? 'twenty five (25)' : licensingYears} years following the commencement of the Term; or (B) the end of the semi-annual accounting period during which your royalty account became fully recouped.

10. First Negotiation/Matching Right: During the Term, and for a period of ${firstNegotiationPeriod == '3' ? 'three (3)' : 'six (6)'} months following the expiration or termination of the Term, prior to entering into negotiations with any third party with respect to your recording services and/or the rights in and to the Masters, you shall first notify us that you would like to negotiate such an agreement, after which you shall negotiate with us exclusively for ${negotiationDays} days.

    a. If, by the expiration of such ${negotiationDays}-day period, no agreement is reached between you and us, you may negotiate with third parties an agreement with respect to your recording services and/or the right to exploit Masters, but may not enter into an agreement with any third party other than us unless you first: (i) notify us in writing of the material terms of the proposed agreement pursuant to which such rights are to be granted and the identities of all proposed parties to such agreement ("Third-Party Offer"); and (ii) offer to enter into an agreement with us on the same material financial terms as the Third-Party Offer ("Matching Right").

    b. If we do not accept the Third-Party Offer within ${matchingDays == '15' ? 'fifteen (15)' : matchingDays} business days after we receive such Third-Party Offer, you may then enter into the agreement set forth in the Third-Party Offer, provided that such agreement is consummated upon the same or better terms (for you) and in the same form set forth in the Third-Party Offer.

Please note that I must reserve the right for Sincerely Yours senior management to modify the terms suggested herein.

Best,

${signatory}`;
            
            return memo;
        }
        
        // Generate PDF
        function generateMemo() {
            const memoText = buildMemoText();
            if (!memoText) return;
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            let yPos = 20;
            const lineHeight = 7;
            const margin = 20;
            const pageWidth = doc.internal.pageSize.width;
            const contentWidth = pageWidth - (margin * 2);
            
            const lines = memoText.split('\n');
            doc.setFontSize(11);
            
            lines.forEach((line, index) => {
                if (yPos > 270) {
                    doc.addPage();
                    yPos = 20;
                }
                
                // Check if this is a header line that should be centered
                const isCentered = line.trim() !== line && (
                    line.includes('c/o Granderson') || 
                    line.includes('150 S. Rodeo') || 
                    line.includes('Beverly Hills')
                );
                
                // Check for italic text (wrapped in *)
                const isItalic = line.startsWith('*') && line.endsWith('*');
                
                if (isCentered) {
                    // Center aligned text (header address lines)
                    const trimmedLine = line.trim();
                    const textWidth = doc.getTextWidth(trimmedLine);
                    const xPos = (pageWidth - textWidth) / 2;
                    doc.text(trimmedLine, xPos, yPos);
                    yPos += lineHeight;
                } else if (isItalic) {
                    // Remove asterisks and set italic
                    const italicText = line.substring(1, line.length - 1);
                    doc.setFont(undefined, 'italic');
                    const splitText = doc.splitTextToSize(italicText, contentWidth);
                    splitText.forEach(textLine => {
                        if (yPos > 270) {
                            doc.addPage();
                            yPos = 20;
                        }
                        doc.text(textLine, margin, yPos);
                        yPos += lineHeight;
                    });
                    doc.setFont(undefined, 'normal');
                } else if (line.includes('**__') && line.includes('__**')) {
                    // Handle bold and underlined text (Sincerely Yours Media LLC header)
                    const cleanLine = line.replace(/\*\*__/g, '').replace(/__\*\*/g, '').trim();
                    doc.setFont(undefined, 'bold');
                    const textWidth = doc.getTextWidth(cleanLine);
                    const xPos = (pageWidth - textWidth) / 2; // Center the text
                    doc.text(cleanLine, xPos, yPos);
                    // Add underline
                    doc.line(xPos, yPos + 1, xPos + textWidth, yPos + 1);
                    doc.setFont(undefined, 'normal');
                    yPos += lineHeight;
                } else if (line.includes('**')) {
                    // Handle bold text
                    let remainingText = line;
                    let xPos = margin;
                    
                    while (remainingText.includes('**')) {
                        const firstBold = remainingText.indexOf('**');
                        const secondBold = remainingText.indexOf('**', firstBold + 2);
                        
                        if (secondBold > -1) {
                            // Text before bold
                            if (firstBold > 0) {
                                doc.setFont(undefined, 'normal');
                                const beforeText = remainingText.substring(0, firstBold);
                                doc.text(beforeText, xPos, yPos);
                                xPos += doc.getTextWidth(beforeText);
                            }
                            
                            // Bold text
                            doc.setFont(undefined, 'bold');
                            const boldText = remainingText.substring(firstBold + 2, secondBold);
                            doc.text(boldText, xPos, yPos);
                            xPos += doc.getTextWidth(boldText);
                            doc.setFont(undefined, 'normal');
                            
                            // Continue with remaining text
                            remainingText = remainingText.substring(secondBold + 2);
                        } else {
                            // No closing bold marker
                            doc.text(remainingText, xPos, yPos);
                            break;
                        }
                    }
                    
                    // Any remaining text after last bold
                    if (remainingText.length > 0) {
                        doc.setFont(undefined, 'normal');
                        doc.text(remainingText, xPos, yPos);
                    }
                    
                    yPos += lineHeight;
                } else {
                    // Regular line without special formatting
                    const splitText = doc.splitTextToSize(line, contentWidth);
                    splitText.forEach(textLine => {
                        if (yPos > 270) {
                            doc.addPage();
                            yPos = 20;
                        }
                        doc.text(textLine, margin, yPos);
                        yPos += lineHeight;
                    });
                }
            });
            
            const artistName = document.getElementById('artistName').value.replace(/\s+/g, '_');
            const date = document.getElementById('date').value;
            const filename = `Deal_Memo_${artistName}_${date}.pdf`;
            doc.save(filename);
        }
        
        // Generate and copy text
        function generateAndCopy() {
            const memoText = buildMemoText();
            if (!memoText) return;
            
            const outputDiv = document.getElementById('output');
            outputDiv.textContent = memoText;
            outputDiv.style.display = 'block';
            
            navigator.clipboard.writeText(memoText).then(() => {
                showSuccess('Deal memo copied to clipboard!');
            }).catch(err => {
                const textArea = document.createElement("textarea");
                textArea.value = memoText;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showSuccess('Deal memo copied to clipboard!');
            });
        }
        
        // Set up when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Set today's date
            document.getElementById('date').valueAsDate = new Date();
            
            // Initialize Google API
            gapi.load('client', initializeGoogleAPI);
            
            // Attach button handlers
            document.getElementById('generatePdfBtn').addEventListener('click', generateMemo);
            document.getElementById('copyBtn').addEventListener('click', generateAndCopy);
            document.getElementById('createGoogleDocBtn').addEventListener('click', createGoogleDoc);
        });
    </script>
</body>
</html>